<?php
session_start();
require 'db.php';

if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'student') {
    header("Location: login.php");
    exit;
}

$user_id = $_SESSION['user_id'];
$studentName = $_SESSION['name'] ?? "Student";
$studentEmail = $_SESSION['email'] ?? "N/A";

// Get category from GET
$category = $_GET['category'] ?? null;
if (!$category) {
    die("Invalid request. Please select a category.");
}

// Fetch all responses for this student and category along with full option texts
$stmt = $pdo->prepare("
    SELECT sr.*, cq.question_text, cq.option_a, cq.option_b, cq.option_c, cq.option_d
    FROM student_responses sr
    JOIN career_questions cq ON sr.question_id = cq.id
    WHERE sr.student_id = ? AND sr.category = ?
    ORDER BY sr.id
");
$stmt->execute([$user_id, $category]);
$responses = $stmt->fetchAll(PDO::FETCH_ASSOC);

if (!$responses) {
    die("No responses found for this category.");
}

// Function to get full text of the selected option
function getOptionText($resp) {
    switch ($resp['selected_option']) {
        case 'A': return $resp['option_a'];
        case 'B': return $resp['option_b'];
        case 'C': return $resp['option_c'];
        case 'D': return $resp['option_d'];
        default: return 'N/A';
    }
}

// Tally categories (for breakdown)
$category_count = [];
foreach ($responses as $resp) {
    $cat = $resp['category'];
    $category_count[$cat] = ($category_count[$cat] ?? 0) + 1;
}
arsort($category_count);
$top_category = array_key_first($category_count);

// Fetch career suggestions
$stmt = $pdo->prepare("SELECT suggestion FROM career_suggestions WHERE category = ?");
$stmt->execute([$top_category]);
$suggestions = $stmt->fetchAll(PDO::FETCH_COLUMN);
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Career Assessment Report</title>
<style>
body { font-family: "Segoe UI", Arial, sans-serif; margin: 40px; line-height: 1.6; color: #333; }
.header { text-align: center; border-bottom: 2px solid #007BFF; padding-bottom: 15px; margin-bottom: 30px; }
.header img { width: 80px; height: auto; margin-bottom: 10px; }
h1 { margin: 0; color: #007BFF; }
h2 { margin-top: 30px; color: #444; }
.student-info { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
.highlight { background: #e9f5ff; padding: 15px; border-radius: 8px; }
ul { margin: 0; padding-left: 20px; }
.print-btn { display: inline-block; margin-bottom: 20px; padding: 10px 20px; background: #007BFF; color: white; border: none; border-radius: 6px; cursor: pointer; }
.print-btn:hover { background: #0056b3; }
@media print { .print-btn { display: none; } }
</style>
</head>
<body>

<div class="header">
    <img src="logo.JPG" alt="System Logo">
    <h1>OrientaCore Career Assessment Report</h1>
    <p><em>Guiding Students Towards Informed Career Choices</em></p>
</div>

<div class="student-info">
    <p><strong>Name:</strong> <?= htmlspecialchars($studentName) ?></p>
    <p><strong>Email:</strong> <?= htmlspecialchars($studentEmail) ?></p>
    <p><strong>Category:</strong> <?= htmlspecialchars($category) ?></p>
</div>

<h2>Your Answers</h2>
<ul>
    <?php foreach ($responses as $resp): ?>
        <li>
            <strong><?= htmlspecialchars($resp['question_text']) ?></strong><br>
            Selected Answer: <?= htmlspecialchars($resp['selected_option']) ?> - <?= htmlspecialchars(getOptionText($resp)) ?>
        </li>
    <?php endforeach; ?>
</ul>

<h2>Category Breakdown</h2>
<ul>
    <?php foreach ($category_count as $cat => $count): ?>
        <li><?= htmlspecialchars($cat) ?>: <?= $count ?> answers</li>
    <?php endforeach; ?>
</ul>

<h2>Recommended Career Paths</h2>
<?php if (!empty($suggestions)): ?>
    <div class="highlight">
        <ul>
            <?php foreach ($suggestions as $s): ?>
                <li><?= htmlspecialchars($s) ?></li>
            <?php endforeach; ?>
        </ul>
    </div>
<?php else: ?>
    <p>No career suggestions available for this category.</p>
<?php endif; ?>

<br><br>
<p><em>Generated by OrientaCore Career Guidance System</em></p>
<button class="print-btn" onclick="window.print()">ðŸ–¨ Print / Save as PDF</button>

</body>
</html>
